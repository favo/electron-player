#!/bin/bash -e


SNAP_DAEMON_HOME=$SNAP_DATA/snap-daemon-home

if [[ ! -d $SNAP_DAEMON_HOME ]]
then
  mkdir -p $SNAP_DAEMON_HOME
  # We `chown snap_daemon $SNAP_DAEMON_HOME` later and
  # this breaks `root` access in the snap ... somehow
  # Try to make sure everyone has execute on the directory
  chmod 0755 $SNAP_DAEMON_HOME
fi

if [[ ! -d $SNAP_DAEMON_HOME/.cache ]]
then
    mkdir -p $SNAP_DAEMON_HOME/.cache
fi

if [[ ! -d $SNAP_DAEMON_HOME/.config ]]
then
    mkdir -p $SNAP_DAEMON_HOME/.config
fi

if [[ ! -d $SNAP_DAEMON_HOME/.local/share ]]
then
    mkdir -p $SNAP_DAEMON_HOME/.local/share
fi

chown snap_daemon:snap_daemon $SNAP_DAEMON_HOME


# Tell Electron where to find data directories
export HOME=$SNAP_DAEMON_HOME
export XDG_CONFIG_HOME=$SNAP_DAEMON_HOME/.config
export XDG_CACHE_HOME=$SNAP_DAEMON_HOME/.cache
export XDG_DATA_HOME=$SNAP_DAEMON_HOME/.local/share
export XDG_DATA_DIRS=$XDG_DATA_HOME:$SNAP_DATA:$SNAP/usr/share

# This is all from desktop-launch and we need to re-set them for the new home
export GDK_PIXBUF_MODULE_FILE=$XDG_CACHE_HOME/gdk-pixbuf-loaders.cache
export GTK_IM_MODULE_FILE=$XDG_CACHE_HOME/immodules/immodules.cache
export GIO_MODULE_DIR=$XDG_CACHE_HOME/gio-modules


# Change to $SNAP/snap-daemon-home to allow Electron write access
cd $SNAP_DAEMON_HOME

"$SNAP/usr/bin/setpriv" --clear-groups --reuid snap_daemon --regid snap_daemon -- "$@"